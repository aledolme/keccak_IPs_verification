#Generated by Edalize
ifndef MODEL_TECH
$(error Environment variable MODEL_TECH was not found. It should be set to <modelsim install path>/bin)
endif

CC ?= gcc
CFLAGS   := -fPIC -fno-stack-protector -g -std=c99
CXXFLAGS := -fPIC -fno-stack-protector -g

LD ?= ld
LDFLAGS := -shared -E

#Try to determine if ModelSim is 32- or 64-bit.
#To manually override, set the environment MTI_VCO_MODE to 32 or 64
ifeq ($(findstring 64, $(shell $(MODEL_TECH)/../vco)),)
CFLAGS   += -m32
CXXFLAGS += -m32
LDFLAGS  += -melf_i386
endif

RM ?= rm
INCS := -I$(MODEL_TECH)/../include

VSIM ?= $(MODEL_TECH)/vsim
VOPT ?= $(MODEL_TECH)/vopt


RUN_OPT = 
ifdef RUN_OPT
    TOPLEVEL      := tb_top_vopt
else
    TOPLEVEL      := tb_top
endif

RUN_UPF_OPTIONS =
RUN_UPF ?= 
ifdef RUN_UPF
    RUN_UPF_OPTIONS := -pa
endif


VPI_MODULES   := 
PARAMETERS    ?= COREV_PULP=0 JTAG_DPI=0
PLUSARGS      ?= 
VSIM_OPTIONS  ?= -sv_lib ../../../hw/vendor/esl_epfl_x_heep/hw/vendor/lowrisc_opentitan/hw/dv/dpi/uartdpi/uartdpi -sv_lib ../../../hw/vendor/esl_epfl_x_heep/hw/vendor/pulp_platform_pulpissimo/rtl/tb/remote_bitbang/librbs -voptargs=+acc
EXTRA_OPTIONS ?= $(VSIM_OPTIONS) $(addprefix -g,$(PARAMETERS)) $(addprefix +,$(PLUSARGS)) $(RUN_UPF_OPTIONS)

all: work $(VPI_MODULES)

run: work $(VPI_MODULES)
	$(VSIM) -c $(addprefix -pli ,$(VPI_MODULES)) $(EXTRA_OPTIONS) -do "run -all; quit -code [expr [coverage attribute -name TESTSTATUS -concise] >= 2 ? [coverage attribute -name TESTSTATUS -concise] : 0]; exit" $(TOPLEVEL)

run-gui: work $(VPI_MODULES)
	$(VSIM) -gui $(addprefix -pli ,$(VPI_MODULES)) $(EXTRA_OPTIONS) $(TOPLEVEL)

work:
	$(VSIM) -c -do "edalize_main.tcl" -do "exit"

clean: 
	rm -rf work

opt:
	$(VOPT) -work work -debugdb -fsmdebug -pedanticerrors +acc=npr $(addprefix -G,$(PARAMETERS)) $(TOPLEVEL) -o $(TOPLEVEL)_vopt

opt-upf:
	$(VOPT) -work work -debugdb -fsmdebug -pa_genrpt=pa+de+cell+conn+pst+srcsink -pa_enable=vsim_msgs+highlight+debug -pa_checks=s+ul+i+p+cp+upc+ugc -pa_upf ../../../core-v-mini-mcu.upf -pa_top "/tb_top/testharness_i/x_heep_system_i/core_v_mini_mcu_i" -pa_lib work +acc=npr $(addprefix -G,$(PARAMETERS)) $(TOPLEVEL) -o $(TOPLEVEL)_vopt
